<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDS workflow functionality • ecmwfr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- ropensci --><link href="../bglabs.css" rel="stylesheet">
<meta property="og:title" content="CDS workflow functionality">
<meta property="og:description" content="ecmwfr">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://bluegreenlabs.org">
          <img src="https://bluegreenlabs.org/img/logo_text_small.png" id="hexlogo" alt="bluegreen labs"></a>
        <a class="external-link hidden-md hidden-lg" href="https://bluegreenlabs.org">
          <img src="https://bluegreenlabs.org/img/logo.png" id="hexlogo" alt="bluegreen labs"></a>
        <a class="navbar-brand" href="../index.html">
           <i>ecmwfr <small>v1.5.1</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ads_vignette.html">ADS functionality</a>
    </li>
    <li>
      <a href="../articles/advanced_vignette.html">Advanced Use Cases</a>
    </li>
    <li>
      <a href="../articles/cds_vignette.html">CDS functionality</a>
    </li>
    <li>
      <a href="../articles/cds_workflow_vignette.html">CDS workflow functionality</a>
    </li>
    <li>
      <a href="../articles/webapi_vignette.html">WebAPI functionality</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/bluegreen-labs/ecmwfr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>CDS workflow functionality</h1>
                        <h4 data-toc-skip class="author">Koen
Hufkens</h4>
            
            <h4 data-toc-skip class="date">2023-03-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bluegreen-labs/ecmwfr/blob/HEAD/vignettes/cds_workflow_vignette.Rmd" class="external-link"><code>vignettes/cds_workflow_vignette.Rmd</code></a></small>
      <div class="hidden name"><code>cds_workflow_vignette.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="running-workflows-on-copernicus-climate-data-store">Running workflows on Copernicus’ Climate Data Store<a class="anchor" aria-label="anchor" href="#running-workflows-on-copernicus-climate-data-store"></a>
</h2>
<p><a href="https://www.copernicus.eu/en" class="external-link">Copernicus.eu</a> provides a
set of interesting data sets for research, education, and applied earth
sciences on their <a href="https://cds.climate.copernicus.eu" class="external-link">Climate
Data Store</a> (CDS). However, in many cases through the conventional
API you can only download the raw data at their native temporal
resolution.</p>
<p>Many people however don’t require hourly or 6-hourly data for their
research purposes. Using the standard API therefore results in queries
of large amount of data which then need to be temporally down-sampled to
get, for example, daily mean temperature values.</p>
<p>Many of these issues can be side stepped by using the <a href="https://cds.climate.copernicus.eu/toolbox/doc/api.html" class="external-link">CDS
Toolbox workflows</a>. These allow you to execute <code>python</code>
code on CDS servers, as provided through an R script.</p>
</div>
<div class="section level2">
<h2 id="the-workflow-syntax">The Workflow syntax<a class="anchor" aria-label="anchor" href="#the-workflow-syntax"></a>
</h2>
<p>Below we’ll use a CDS Toolbox python script to extract a time series
for a variable at a given (point) location. This is a common operation
for people working with point (site/location) data.</p>
<p>On the CDS website the example script
<code>03 Extract time series and plot graph</code> in the toolbox editor
allows you to extract a daily mean time series for a given (defined)
variable and a given location. The code below is normally used within
the context of the CDS Toolbox Editor platform. However, we can reuse
the same code within the context of a <code>ecmwfr</code> workflow
request.</p>
<p>The code below lists all available variables to consider in
combination with an API call defining the data ranges available (both
spatial and temporal). This example is limited to the years 2008 - 2017
and 6-hourly time steps (although more data is available).</p>
<p>We will make one minor change to the original script which is
critical for the success of our workflow. Instead of returning a figure,
we will want to return the data on which the figure is based. We
therefore changed the last line of the original file to
<code>return data_daily</code>. We also set the output format from a
live figure to a download. We can then save this script as a normal
python script in any editor. For this example the data was saved into a
file called <code>era5.py</code></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cdstoolbox <span class="im">as</span> ct</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>layout <span class="op">=</span> {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'input_ncols'</span>: <span class="dv">3</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>variables <span class="op">=</span> {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Near-Surface Air Temperature'</span>: <span class="st">'2m_temperature'</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Eastward Near-Surface Wind'</span>: <span class="st">'10m_u_component_of_wind'</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Northward Near-Surface Wind'</span>: <span class="st">'10m_v_component_of_wind'</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sea Level Pressure'</span>: <span class="st">'mean_sea_level_pressure'</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sea Surface Temperature'</span>: <span class="st">'sea_surface_temperature'</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="at">@ct.application</span>(title<span class="op">=</span><span class="st">'Extract a time series and plot graph'</span>, layout<span class="op">=</span>layout)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="at">@ct.input.dropdown</span>(<span class="st">'var'</span>, label<span class="op">=</span><span class="st">'Variable'</span>, values<span class="op">=</span>variables.keys(), description<span class="op">=</span><span class="st">'Sample variables'</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="at">@ct.input.text</span>(<span class="st">'lon'</span>, label<span class="op">=</span><span class="st">'Longitude'</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>, default<span class="op">=</span><span class="fl">75.</span>, description<span class="op">=</span><span class="st">'Decimal degrees'</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="at">@ct.input.text</span>(<span class="st">'lat'</span>, label<span class="op">=</span><span class="st">'Latitude'</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>, default<span class="op">=</span><span class="fl">43.</span>, description<span class="op">=</span><span class="st">'Decimal degrees'</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># @ct.output.livefigure() # Disable live figure!</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="at">@ct.output.download</span>() <span class="co"># Enable a plain download</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_time_series(var, lon, lat):</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Application main steps:</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">    - set the application layout with 3 columns for the input and output at the bottom</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">    - retrieve a variable over a defined time range</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">    - select a location, defined by longitude and latitude coordinates</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">    - compute the daily average</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">    - show the result as a timeseries on an interactive chart</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time range</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> ct.catalogue.retrieve(</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reanalysis-era5-single-levels'</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">'variable'</span>: variables[var],</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">'grid'</span>: [<span class="st">'3'</span>, <span class="st">'3'</span>],</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">'product_type'</span>: <span class="st">'reanalysis'</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'year'</span>: [</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">'2008'</span>, <span class="st">'2009'</span>, <span class="st">'2010'</span>,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">'2011'</span>, <span class="st">'2012'</span>, <span class="st">'2013'</span>,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">'2014'</span>, <span class="st">'2015'</span>, <span class="st">'2016'</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">'2017'</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month'</span>: [</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">'01'</span>, <span class="st">'02'</span>, <span class="st">'03'</span>, <span class="st">'04'</span>, <span class="st">'05'</span>, <span class="st">'06'</span>,</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>                <span class="st">'07'</span>, <span class="st">'08'</span>, <span class="st">'09'</span>, <span class="st">'10'</span>, <span class="st">'11'</span>, <span class="st">'12'</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">'day'</span>: [</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">'01'</span>, <span class="st">'02'</span>, <span class="st">'03'</span>, <span class="st">'04'</span>, <span class="st">'05'</span>, <span class="st">'06'</span>,</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">'07'</span>, <span class="st">'08'</span>, <span class="st">'09'</span>, <span class="st">'10'</span>, <span class="st">'11'</span>, <span class="st">'12'</span>,</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">'13'</span>, <span class="st">'14'</span>, <span class="st">'15'</span>, <span class="st">'16'</span>, <span class="st">'17'</span>, <span class="st">'18'</span>,</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">'19'</span>, <span class="st">'20'</span>, <span class="st">'21'</span>, <span class="st">'22'</span>, <span class="st">'23'</span>, <span class="st">'24'</span>,</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>                <span class="st">'25'</span>, <span class="st">'26'</span>, <span class="st">'27'</span>, <span class="st">'28'</span>, <span class="st">'29'</span>, <span class="st">'30'</span>,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>                <span class="st">'31'</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">'time'</span>: [<span class="st">'00:00'</span>, <span class="st">'06:00'</span>, <span class="st">'12:00'</span>, <span class="st">'18:00'</span>],</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Location selection</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the closest point to selected lon/lat (no interpolation).</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If wrong number is set for latitude, the closest available one is chosen:</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># e.g. if lat = 4000 -&gt; lat = 90.</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If wrong number is set for longitude, first a wrap in [-180, 180] is made,</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># then the closest one present is chosen:</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># e.g. if lon = 200 -&gt; lon = -160.</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    data_sel <span class="op">=</span> ct.geo.extract_point(data, lon<span class="op">=</span>lon, lat<span class="op">=</span>lat)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Daily mean on selection</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    data_daily <span class="op">=</span> ct.climate.daily_mean(data_sel)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> ct.chart.line(data_daily)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">#return fig</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_daily</span></code></pre></div>
<p>With the script adjusted and saved we can now use it in our
<code>ecmwfr</code> workflow run as follows.</p>
<p>First we read in the python script as a long string into R. Use
<code>readlines()</code> and collapse the various lines using the
appropriate <code>\n</code> separator.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"era5.py"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<p>We then have to formulate a query which sets the right variables in
the python script, mainly the parameters <code>var</code>,
<code>lat</code> and <code>lon</code>. The request is a nested list with
a <code>code</code> argument, containing the code you want to run, a
<code>kwargs</code> variable containing a named list of variables to
forward to the code, a <code>workflow_name</code> defining the python
application you want to call (in this case
<code>plot_time_series</code>, and a <code>target</code> output variable
name setting the filename of the resulting output.</p>
<p>With a correct query specified we can now run this workflow request
using a normal <code><a href="../reference/wf_request.html">wf_request()</a></code> call, which will run the code
on the CDS server and return the result to the target file.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A query for 2m surface temperature</span></span>
<span><span class="va">request</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  code <span class="op">=</span> <span class="va">code</span>,</span>
<span>  kwargs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      var <span class="op">=</span> <span class="st">"2m_temperature"</span>,</span>
<span>      lat <span class="op">=</span> <span class="fl">50</span>,</span>
<span>      lon <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span>,</span>
<span>  workflow_name <span class="op">=</span> <span class="st">"plot_time_series"</span>, <span class="co"># name of the python subroutine / app</span></span>
<span>  target <span class="op">=</span> <span class="st">"test.nc"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># download the data</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wf_request.html">wf_request</a></span><span class="op">(</span></span>
<span>    user <span class="op">=</span> <span class="va">USER_ID</span>,</span>
<span>    request <span class="op">=</span> <span class="va">request</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Once the file is downloaded we can open this file using the
<code>ncdf4</code> library. Depending on the python script used you will
be returned either <code>netCDF</code> formatted geospatial data
(i.e. maps) or non-geospatial data. In this case the returned data is
not geospatial, a time-series for our desired location.</p>
<p>Below we open the <code>netCDF</code> file and read in the
temperature (t2m) data into variable <code>t</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># open the netcdf file and print the meta-data</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_open.html" class="external-link">nc_open</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"test.nc"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read in the temperature data stored in field "t2m"</span></span>
<span><span class="co"># and the dates from the "time" field</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html" class="external-link">ncvar_get</a></span><span class="op">(</span>nc <span class="op">=</span> <span class="va">f</span>, <span class="st">"t2m"</span><span class="op">)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html" class="external-link">ncvar_get</a></span><span class="op">(</span>nc <span class="op">=</span> <span class="va">f</span>, <span class="st">"time"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the starting point of the time series</span></span>
<span><span class="co"># and add the increments (time)</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_get.html" class="external-link">ncatt_get</a></span><span class="op">(</span><span class="va">f</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">$</span><span class="va">units</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">start</span>, format <span class="op">=</span> <span class="st">"days since %Y-%m-%d 00:00:00"</span><span class="op">)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">start</span> <span class="op">+</span> <span class="va">time</span></span>
<span></span>
<span><span class="co"># close the file once done</span></span>
<span><span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_close.html" class="external-link">nc_close</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span></code></pre></div>
<p>We can now plot this data</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">temp</span>, ylab <span class="op">=</span> <span class="st">"Temperature (K)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cds_workflow_vignette_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="http://github.com/bluegreen-labs" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://bluegreenlabs.org/labs/" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/bluegreen_labs" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://bluegreenlabs.org/#intro" class="external-link">BlueGreen Labs</a></li>
                            <li><a href="https://bluegreenlabs.org/#people" class="external-link">Our Team</a></li>
                            <li><a href="https://bluegreenlabs.org/#contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/bluegreen-labs" class="external-link">Packages</a></li>
                            <li><a href="https://bluegreenlabs.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://bluegreenlabs.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>

  


  

  </body>
</html>
